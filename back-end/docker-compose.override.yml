services:
  postgres:
    hostname: ltpostgres
    container_name: ltpostgres
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=adminpassword
      - POSTGRES_DB=littypicky
      - POSTGRES_PASSWORD_FILE=
      - POSTGRES_USER_FILE=
    secrets: []
    volumes:
      - ltpostgres_data:/var/lib/postgresql/data
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    networks:
      - litty-net
  mailhog:
    image: mailhog/mailhog:latest
    container_name: ltmailhog
    hostname: ltmailhog
    networks:
      - litty-net
    ports:
      - "1025:1025"
      - "8025:8025"

  mockoidc:
    image: ghcr.io/navikt/mock-oauth2-server:2.1.10
    container_name: ltmockoidc
    hostname: ltmockoidc
    networks:
      - litty-net
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - LOG_LEVEL=INFO
      - JSON_CONFIG={"interactiveLogin":true,"httpServer":"NettyWrapper","tokenCallbacks":[{"issuerId":"google","tokenExpiry":3600,"requestMappings":[{"requestParam":"scope","match":".*","claims":{"sub":"mock-google-user-123","email":"testuser@gmail.com","email_verified":true,"given_name":"Test","family_name":"User","picture":"https://example.com/avatar.jpg"}}]}]}
  backend:
    container_name: ltbackend
    hostname: ltbackend
    networks:
      - litty-net
    image: rust:latest
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    working_dir: /app
    command: >
      cargo run
      # sh -c "
      #   cargo install cargo-watch &&
      #   cargo watch -x 'run'
      # "
    ports:
      - "6780:6780"
    environment:
      - RUST_LOG=info,back_end=debug
      - RUST_BACKTRACE=1
      - SQLX_OFFLINE=true
      - JWT_SECRET=jwt_secret_dev
      - DATABASE_URL=postgres://admin:adminpassword@ltpostgres:5432/littypicky
      - DISABLE_RATE_LIMIT=1
      - SMTP_SERVER=mailhog:1025
      - SMTP_USERNAME=
      - SMTP_PASSWORD=
      - SMTP_FROM_EMAIL=noreply@logsmart.app
      - SMTP_FROM_NAME="LogSmart Dev"
      - GOOGLE_CLIENT_ID=mock-google-client-id
      - GOOGLE_CLIENT_SECRET=mock-google-client-secret
      - GOOGLE_ISSUER_URL=http://ltmockoidc:8080/google
      - GOOGLE_REDIRECT_URI=http://localhost:6780/auth/google/callback
      - FRONTEND_URL=http://localhost:5173
      - S3_ENDPOINT=http://minio:2096
      - S3_PUBLIC_URL=http://localhost:2096/littypicky-images
      - POSTGRES_PASSWORD_FILE=
      - POSTGRES_USER_FILE=
      - MONGODB_URI_FILE=
      - JWT_SECRET_FILE=
      - SMTP_USERNAME_FILE=
      - SMTP_PASSWORD_FILE=
      - GOOGLE_CLIENT_ID_FILE=
      - GOOGLE_CLIENT_SECRET_FILE=
      - DATABASE_URL_FILE=
      - TLS_CERT_PATH=
      - TLS_KEY_PATH=
    depends_on:
      - postgres
      - mailhog
      - mockoidc
      - minio
    secrets: []
    
volumes:
  cargo-cache:
  target-cache:
  ltpostgres_data:
networks:
  litty-net:
    driver: bridge

secrets:
  lp_jwt_secret_v1:
    file: /dev/null
    external: false
  lp_smtp_username_v1:
    file: /dev/null
    external: false
  lp_smtp_password_v1:
    file: /dev/null
    external: false
  lp_google_client_id_v1:
    file: /dev/null
    external: false
  lp_google_client_secret_v1:
    file: /dev/null
    external: false
  lp_postgres_url_v1:
    file: /dev/null
    external: false
  lp_postgres_user_v1:
    file: /dev/null
    external: false
  lp_postgres_password_v1:
    file: /dev/null
    external: false
